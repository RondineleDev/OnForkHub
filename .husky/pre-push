#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

export LC_ALL=en_US.UTF-8
export LANG=en_US.UTF-8

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
RESET=$(tput sgr0)

if [[ $BRANCH_NAME =~ $PROTECTED_BRANCHES ]]; then
    echo "${RED}‚ùå Direct push to $BRANCH_NAME branch is not allowed!${RESET}"
    echo "${YELLOW}‚ÑπÔ∏è  Please:${RESET}"
    echo "1. Create a feature or hotfix branch"
    echo "2. Push to this branch"
    echo "3. Create a Pull Request"
    exit 1
fi

echo "üöÄ Preparing to push changes..."
echo "----------------------------------"

echo "üß™ Running unit tests..."
dotnet test --no-restore --logger "console;verbosity=normal"
TEST_RESULT=$?

echo "----------------------------------"
if [ $TEST_RESULT -eq 0 ]; then
    echo "${GREEN}‚úÖ Tests Completed Successfully!${RESET}"
    echo "${YELLOW}üìä Test Summary from last run:${RESET}"
    dotnet test --no-build --no-restore --logger "console;verbosity=minimal"
    echo "----------------------------------"
    echo "üöÄ Ready to push!"
else
    echo "${RED}‚ùå Some tests failed!${RESET}"
    echo "${YELLOW}üìä Test Summary from last run:${RESET}"
    dotnet test --no-build --no-restore --logger "console;verbosity=detailed"
    echo "----------------------------------"
    echo "${RED}‚ùå Push blocked due to test failures${RESET}"
    exit 1
fi
